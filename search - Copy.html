<!DOCTYPE html>
<html lang="en" class="bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Track Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; cursor: pointer; background: transparent; }
        input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: #4a5568; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -5px; height: 16px; width: 16px; background: #ffffff; border-radius: 50%; border: 1px solid #cbd5e0; }
        input[type="range"]::-moz-range-track { height: 6px; background: #4a5568; border-radius: 3px; }
        input[type="range"]::-moz-range-thumb { height: 16px; width: 16px; background: #ffffff; border-radius: 50%; border: 1px solid #cbd5e0; }
        .player-controls { display: none; }
        .is-playing .player-details { display: none; }
        .is-playing .player-controls { display: block; }
    </style>
</head>
<body class="text-white">

    <!-- Login Screen -->
    <div id="login-container" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">Spotify Track Search</h1>
            <p class="text-gray-400 mb-8 max-w-md">Please log in to your Spotify Premium account to search for and play full tracks directly in your browser.</p>
            <button id="login-button" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105">
                Login with Spotify
            </button>
            <p id="config-error" class="text-red-400 mt-6 hidden">Error: The Client ID has not been set. Please edit the HTML file and add your Client ID.</p>
        </div>
    </div>

    <!-- Main App Screen (hidden by default) -->
    <div id="app-container" class="min-h-screen flex-col items-center p-4 sm:p-6 lg:p-8 pb-32 hidden">
        <div class="w-full max-w-4xl">
            <!-- Header with User Info -->
            <header class="flex justify-between items-center mb-8">
                <div id="user-profile" class="flex items-center gap-3">
                    <!-- User info will be populated by JS -->
                </div>
                <button id="logout-button" class="text-sm text-gray-400 hover:text-white transition">Logout</button>
            </header>

            <!-- Search Bar -->
            <div class="relative mb-8">
                <input type="text" id="searchInput" placeholder="Search for a song or artist..." class="w-full p-4 pl-12 text-lg bg-gray-800 border-2 border-gray-700 rounded-full focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition duration-300 text-white">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>

            <!-- Loading Spinner & Results -->
            <div id="loading" class="text-center hidden">
                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24" 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-400">Searching...</p>
            </div>
            <div id="results" class="space-y-4"></div>
            <div id="error" class="text-center text-red-400 hidden mt-8 p-4 bg-red-900/50 rounded-lg"></div>
        </div>
    </div>
    
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // --- CONFIGURATION: PASTE YOUR CLIENT ID HERE ---
        const CLIENT_ID = "4ec2098d4c8f49149f5b4bca2850bfd5";
        
        // --- CONSTANTS ---
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = [
            "streaming",
            "user-read-email",
            "user-read-private",
            "user-read-playback-state",
            "user-modify-playback-state"
        ].join(" ");
        
        // --- DOM ELEMENTS ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('results');
        const loadingIndicator = document.getElementById('loading');
        const errorContainer = document.getElementById('error');
        const userProfileDiv = document.getElementById('user-profile');
        const configError = document.getElementById('config-error');

        // --- SPOTIFY PLAYER STATE ---
        let player;
        let deviceId = null;
        let updateInterval;
        let currentlyPlayingTile = null;
        let currentTrackUri = null;

        // --- AUTH & API ---

        window.onload = () => {
            if (CLIENT_ID === "PASTE_YOUR_CLIENT_ID_HERE") {
                loginContainer.classList.remove('hidden');
                configError.classList.remove('hidden');
                loginButton.disabled = true;
                loginButton.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                handleRedirect(code);
            } else {
                const accessToken = localStorage.getItem('spotify_access_token');
                if (accessToken) {
                    initializeApp();
                } else {
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            }
        };

        loginButton.addEventListener('click', redirectToSpotifyLogin);
        logoutButton.addEventListener('click', logout);

        async function redirectToSpotifyLogin() {
            const verifier = generateCodeVerifier(128);
            const challenge = await generateCodeChallenge(verifier);

            localStorage.setItem("spotify_code_verifier", verifier);

            const params = new URLSearchParams();
            params.append("client_id", CLIENT_ID);
            params.append("response_type", "code");
            params.append("redirect_uri", REDIRECT_URI);
            params.append("scope", SCOPES);
            params.append("code_challenge_method", "S256");
            params.append("code_challenge", challenge);

            document.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function handleRedirect(code) {
            const verifier = localStorage.getItem("spotify_code_verifier");
            if (!verifier) {
                showError("Code verifier not found. Please try logging in again.");
                return;
            }
            
            try {
                const tokenData = await getAccessToken(code, verifier);
                storeTokens(tokenData);
                // Clean URL
                window.history.pushState({}, document.title, window.location.pathname);
                initializeApp();
            } catch (error) {
                showError(`Error fetching token: ${error.message}`);
                logout();
            }
        }
        
        async function getAccessToken(code, verifier) {
            const params = new URLSearchParams();
            params.append("client_id", CLIENT_ID);
            params.append("grant_type", "authorization_code");
            params.append("code", code);
            params.append("redirect_uri", REDIRECT_URI);
            params.append("code_verifier", verifier);
            
            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error_description || "Failed to get access token.");
            }
            return response.json();
        }

        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            if (!refreshToken) {
                logout();
                throw new Error("No refresh token available.");
            }

            const params = new URLSearchParams();
            params.append("client_id", CLIENT_ID);
            params.append("grant_type", "refresh_token");
            params.append("refresh_token", refreshToken);

            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params
            });
            
            if (!response.ok) {
                 logout(); // If refresh fails, log out
                 const errorData = await response.json();
                 throw new Error(errorData.error_description || "Failed to refresh token.");
            }
            
            const tokenData = await response.json();
            storeTokens(tokenData); // The new response might not include a new refresh token
            return tokenData.access_token;
        }

        function storeTokens(tokenData) {
            const expiryTime = new Date().getTime() + tokenData.expires_in * 1000;
            localStorage.setItem('spotify_access_token', tokenData.access_token);
            localStorage.setItem('spotify_token_expiry', expiryTime);
            // Spotify may not return a new refresh token, only store it if it exists
            if (tokenData.refresh_token) {
                 localStorage.setItem('spotify_refresh_token', tokenData.refresh_token);
            }
        }
        
        async function getValidAccessToken() {
            const expiryTime = localStorage.getItem('spotify_token_expiry');
            if (new Date().getTime() > expiryTime) {
                console.log("Access token expired, refreshing...");
                return await refreshAccessToken();
            }
            return localStorage.getItem('spotify_access_token');
        }

        async function makeApiCall(url) {
            const accessToken = await getValidAccessToken();
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (response.status === 401) { // Unauthorized
                console.log("Token might be invalid, trying to refresh...");
                const newAccessToken = await refreshAccessToken();
                // Retry the call with the new token
                return fetch(url, {
                    headers: { 'Authorization': `Bearer ${newAccessToken}` }
                });
            }
            return response;
        }

        function logout() {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_token_expiry');
            localStorage.removeItem('spotify_code_verifier');
            player?.disconnect(); // Disconnect player if it exists
            window.location.href = REDIRECT_URI; // Reload to show login
        }

        // --- PKCE HELPER FUNCTIONS ---
        function generateCodeVerifier(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // --- APPLICATION LOGIC ---
        async function initializeApp() {
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            
            initializePlayer();
            fetchUserProfile();
        }
        
        async function fetchUserProfile() {
            try {
                const response = await makeApiCall("https://api.spotify.com/v1/me");
                if (!response.ok) throw new Error("Failed to fetch user profile.");
                const data = await response.json();
                userProfileDiv.innerHTML = `
                    <img src="${data.images[0]?.url || 'https://via.placeholder.com/40'}" alt="profile picture" class="w-10 h-10 rounded-full">
                    <span class="font-medium">${data.display_name}</span>
                `;
            } catch (error) {
                userProfileDiv.innerHTML = `<span class="text-red-400 text-sm">${error.message}</span>`;
            }
        }
        
        // --- SPOTIFY SDK Initialization ---
        window.onSpotifyWebPlaybackSDKReady = () => { /* Will be called from initializeApp */ };
        
        async function initializePlayer() {
            const accessToken = await getValidAccessToken();
             player = new Spotify.Player({
                name: 'Web Playback SDK App',
                getOAuthToken: cb => { cb(accessToken); },
                volume: 0.5
            });

            player.addListener('initialization_error', ({ message }) => { showError(`Initialization Error: ${message}`); });
            player.addListener('authentication_error', ({ message }) => { showError(`Authentication Error: ${message}.`); logout(); });
            player.addListener('account_error', ({ message }) => { showError(`Account Error: ${message}. Spotify Premium is required.`); });
            player.addListener('playback_error', ({ message }) => { showError(`Playback Error: ${message}`); });
            player.addListener('ready', ({ device_id }) => { console.log('Ready with Device ID', device_id); deviceId = device_id; });
            player.addListener('not_ready', ({ device_id }) => { console.log('Device ID has gone offline', device_id); deviceId = null; });
            player.addListener('player_state_changed', state => {
                if (!state || !currentlyPlayingTile) return;
                const isPaused = state.paused;
                currentlyPlayingTile.querySelector('.play-icon').classList.toggle('hidden', !isPaused);
                currentlyPlayingTile.querySelector('.pause-icon').classList.toggle('hidden', isPaused);
                if (!isPaused) startInterval(); else stopInterval();
            });
            player.connect().then(success => {
                if (success) console.log('Spotify Player connected successfully!');
            });
        }

        // --- SEARCH & PLAYBACK (Existing Logic Adapted) ---
        let searchTimeout;
        searchInput.addEventListener('keyup', (event) => {
            clearTimeout(searchTimeout);
            if (event.key === 'Enter') {
                handleSearch();
            } else {
                 searchTimeout = setTimeout(handleSearch, 500);
            }
        });

        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) { resultsContainer.innerHTML = ''; return; }

            loadingIndicator.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            errorContainer.classList.add('hidden');

            try {
                const response = await makeApiCall(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                displayResults(data.tracks.items);
            } catch (err) {
                showError(err.message);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        function displayResults(items) {
            // (This function remains mostly the same as before)
            if (!items || items.length === 0) {
                resultsContainer.innerHTML = `<p class="text-center text-gray-400">No tracks found.</p>`;
                return;
            }

            resultsContainer.innerHTML = items.map(item => `
                <div class="bg-gray-800 rounded-lg transition track-item" data-track-uri="${item.uri}" >
                    <div class="player-details flex items-center gap-4 p-3 cursor-pointer hover:bg-gray-700 rounded-lg">
                        <img src="${item.album.images[0]?.url || 'https://via.placeholder.com/64'}" alt="album art" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                        <div class="flex-grow min-w-0">
                            <h2 class="font-semibold text-white truncate">${escapeHTML(item.name)}</h2>
                            <p class="text-sm text-gray-400">${escapeHTML(item.artists.map(a => a.name).join(', '))}</p>
                        </div>
                    </div>
                    <div class="player-controls p-3">
                         <div class="flex items-center gap-4">
                            <img src="${item.album.images[0]?.url || 'https://via.placeholder.com/64'}" alt="album art" class="w-16 h-16 object-cover rounded-md flex-shrink-0">
                            <h2 class="font-semibold text-white truncate flex-grow">${escapeHTML(item.name)}</h2>
                        </div>
                        <div class="flex items-center gap-3 mt-2">
                            <button class="play-pause-btn w-10 h-10 flex items-center justify-center bg-green-600 rounded-full text-white hover:bg-green-500 transition">
                                <svg class="play-icon w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                                <svg class="pause-icon w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zM14.25 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z" /></svg>
                            </button>
                            <span class="current-time text-sm text-gray-300 w-12 text-center">0:00</span>
                            <input type="range" class="scrub-bar flex-grow" value="0" min="0" max="100" step="0.1">
                            <span class="duration text-sm text-gray-300 w-12 text-center">0:00</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            attachClickListeners();
        }

        function attachClickListeners() {
            // (This function remains mostly the same as before)
            document.querySelectorAll('.track-item').forEach(item => {
                const detailsView = item.querySelector('.player-details');
                const playPauseBtn = item.querySelector('.play-pause-btn');
                const scrubBar = item.querySelector('.scrub-bar');

                detailsView.addEventListener('click', () => {
                    const trackUri = item.dataset.trackUri;
                    if (currentTrackUri === trackUri) return;
                    if (currentlyPlayingTile) currentlyPlayingTile.classList.remove('is-playing');
                    currentlyPlayingTile = item;
                    item.classList.add('is-playing');
                    playTrack(trackUri);
                });
                playPauseBtn.addEventListener('click', () => player?.togglePlay());
                scrubBar.addEventListener('input', () => {
                    player.getCurrentState().then(state => {
                        if (state) player.seek(state.duration * (scrubBar.value / 100));
                    });
                });
            });
        }

        async function playTrack(trackUri) {
            if (!deviceId) {
                showError("No active Spotify device. Please ensure Spotify is running or wake up the player by clicking play in another Spotify app.");
                return;
            }
            currentTrackUri = trackUri;
            const accessToken = await getValidAccessToken();
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [trackUri] }),
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
            }).catch(err => showError(`Error playing track: ${err.message}`));
        }

        function updateTime() {
            // (This function remains the same as before)
            if (player && currentlyPlayingTile) {
                player.getCurrentState().then(state => {
                    if (!state) return;
                    const { position, duration } = state;
                    currentlyPlayingTile.querySelector('.scrub-bar').value = (position / duration) * 100;
                    currentlyPlayingTile.querySelector('.current-time').textContent = formatTime(position);
                    currentlyPlayingTile.querySelector('.duration').textContent = formatTime(duration);
                });
            }
        }
        
        // --- UTILITY FUNCTIONS (mostly the same) ---
        function startInterval() { stopInterval(); updateInterval = setInterval(updateTime, 500); }
        function stopInterval() { clearInterval(updateInterval); }
        function formatTime(ms) { const s = Math.floor(ms/1000); const m = Math.floor(s/60); return `${m}:${(s%60)<10?'0':''}${s%60}`; }
        function escapeHTML(str) { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; }
        function showError(message) { errorContainer.textContent = message; errorContainer.classList.remove('hidden'); }
    </script>
</body>
</html>

